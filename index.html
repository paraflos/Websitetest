<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalender med Google-login</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f2f2f2; padding: 20px; text-align: center; }
  #calendar-container { display: none; max-width: 900px; margin: 20px auto; background: white; border-radius: 8px; padding: 20px; }
  .calendar-header { display: flex; justify-content: center; align-items: center; gap: 20px; font-size: 24px; margin-bottom: 20px; }
  .calendar-header button { font-size: 28px; background: transparent; border: none; cursor: pointer; color: #4CAF50; }
  .calendar-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 20px; }
  .calendar-table th, .calendar-table td { width: 12.5%; border: 1px solid #ddd; text-align: center; padding: 15px; vertical-align: top; word-wrap: break-word; }
  .calendar-table th:first-child, .calendar-table td:first-child { width: 5%; background-color: #f0f0f0; font-size: 12px; font-weight: bold; }
  .week-number { background-color: #f0f0f0; font-size: 12px; font-weight: bold; padding: 10px 5px; }
  .calendar-day { cursor: pointer; min-height: 60px; position: relative; transition: background-color 0.2s ease; }
  .calendar-day:hover { background-color: #f9f9f9; }
  .calendar-day.has-event { background-color: #e0f7e0; }
  .day-button { background-color: #007BFF; color: white; border: none; padding: 15px 25px; font-size: 18px; border-radius: 25px; margin: 5px; cursor: pointer; transition: 0.3s; }
  .day-button:hover { background-color: #0056b3; transform: translateY(-2px); }
  .event-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                 background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.3);
                 z-index: 1000; width: 320px; max-width: 90%; }
  .event-popup input, .event-popup textarea { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;
                                             font-size: 14px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
  .event-popup button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
  .event-popup button:hover { background-color: #45a049; }
  .event-popup .close { position: absolute; top: 8px; right: 12px; font-size: 18px; border: none; background: none; cursor: pointer; color: #666; font-weight: bold; }
  #login-section { margin-bottom: 20px; }
  #logoutBtn { display: none; }
</style>
</head>
<body>

<div id="login-section">
  <button id="googleLogin">Logga in med Google</button>
  <button id="logoutBtn">Logga ut</button>
  <p id="user-info"></p>
</div>

<div id="calendar-container">
  <div class="calendar-header">
    <button onclick="changeMonth(-1)">◀</button>
    <span id="calendar-header">Månad År</span>
    <button onclick="changeMonth(1)">▶</button>
  </div>
  <table class="calendar-table" id="calendar-table"></table>

  <h2>Välj dag:</h2>
  <div id="day-buttons">
    <button class="day-button">Måndag</button>
    <button class="day-button">Tisdag</button>
    <button class="day-button">Onsdag</button>
    <button class="day-button">Torsdag</button>
    <button class="day-button">Fredag</button>
    <button class="day-button">Lördag</button>
    <button class="day-button">Söndag</button>
  </div>
</div>

<div class="event-popup" id="event-popup">
  <button class="close" onclick="closePopup()">×</button>
  <h3>Händelse för <span id="event-date"></span></h3>
  <input type="text" id="event-title" placeholder="Titel" />
  <textarea id="event-description" placeholder="Beskrivning" rows="4"></textarea>
  <button onclick="saveEvent()">Spara</button>
  <button onclick="clearEvent()" style="background-color: #d9534f; margin-left:10px;">Rensa</button>
</div>

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC84mk3Jsw3G9UTavF71ckPfZOUvipzGk0",
    authDomain: "calendertestv1.firebaseapp.com",
    projectId: "calendertestv1",
    storageBucket: "calendertestv1.firebasestorage.app",
    messagingSenderId: "238645323183",
    appId: "1:238645323183:web:f4866217bfa9740297fb5a",
    measurementId: "G-ZW71E6Z68M"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginBtn = document.getElementById("googleLogin");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("user-info");
  const calendarContainer = document.getElementById("calendar-container");

  let selectedDate = null;
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();
  let events = {};

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => console.error(err));
  };

  logoutBtn.onclick = () => auth.signOut();

  auth.onAuthStateChanged(user => {
    if(user){
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      userInfo.textContent = `Inloggad som: ${user.displayName}`;
      calendarContainer.style.display = "block";

      // Ladda händelser
      db.collection("users").doc(user.uid).collection("events").get()
        .then(snapshot => {
          events = {};
          snapshot.forEach(doc => { events[doc.id] = doc.data(); });
          renderCalendar();
        });
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      userInfo.textContent = "";
      calendarContainer.style.display = "none";
    }
  });

  const months = ["Januari","Februari","Mars","April","Maj","Juni","Juli","Augusti","September","Oktober","November","December"];
  const weekdays = ["Sön","Mån","Tis","Ons","Tor","Fre","Lör"];

  function getWeekNumber(date){
    const temp = new Date(date.getTime());
    temp.setHours(0,0,0,0);
    temp.setDate(temp.getDate() + 4 - (temp.getDay()||7));
    const yearStart = new Date(temp.getFullYear(),0,1);
    return Math.ceil((((temp - yearStart)/86400000)+1)/7);
  }

  function renderCalendar(){
    const year = currentYear;
    const month = currentMonth;
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month+1, 0);

    document.getElementById('calendar-header').textContent = `${months[month]} ${year}`;
    const table = document.getElementById('calendar-table');
    table.innerHTML = "";

    const thead = table.createTHead();
    const headRow = thead.insertRow();
    const weekHead = document.createElement('th');
    weekHead.textContent = "Vecka";
    headRow.appendChild(weekHead);
    weekdays.forEach(day => {
      const th = document.createElement('th');
      th.textContent = day;
      headRow.appendChild(th);
    });

    const tbody = table.createTBody();
    let row = tbody.insertRow();
    let currentDate = new Date(year, month, 1);
    let firstWeek = getWeekNumber(currentDate);
    let weekCell = row.insertCell();
    weekCell.className = 'week-number';
    weekCell.textContent = "v. " + firstWeek;

    for(let i=0;i<currentDate.getDay();i++) row.insertCell();

    for(let day=1; day<=lastDay.getDate(); day++){
      currentDate = new Date(year, month, day);
      if(row.cells.length===8){
        row = tbody.insertRow();
        let weekNum = getWeekNumber(currentDate);
        let weekCell = row.insertCell();
        weekCell.className='week-number';
        weekCell.textContent='v. '+weekNum;
      }
      const cell = row.insertCell();
      cell.className='calendar-day';
      cell.textContent=day;
      cell.onclick=()=>showPopup(year, month, day);
      const dateStr = currentDate.toISOString().split('T')[0];
      if(events[dateStr]) cell.classList.add('has-event');
    }
  }

  function changeMonth(dir){ currentMonth+=dir; if(currentMonth<0){currentMonth=11;currentYear--;} else if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); }

  function showPopup(y,m,d){
    selectedDate=new Date(y,m,d);
    const dateStr=selectedDate.toISOString().split('T')[0];
    const ev=events[dateStr]||{};
    document.getElementById('event-date').textContent=dateStr;
    document.getElementById('event-title').value=ev.title||'';
    document.getElementById('event-description').value=ev.description||'';
    document.getElementById('event-popup').style.display='block';
  }

  function closePopup(){ document.getElementById('event-popup').style.display='none'; }

  function saveEvent(){
    if(!selectedDate) return;
    const title=document.getElementById('event-title').value.trim();
    const description=document.getElementById('event-description').value.trim();
    const dateStr=selectedDate.toISOString().split('T')[0];
    const user=auth.currentUser;
    if(!user) return alert("Logga in först!");
    db.collection("users").doc(user.uid).collection("events").doc(dateStr).set({title,description})
      .then(()=>{ events[dateStr]={title,description}; closePopup(); renderCalendar(); });
  }

  function clearEvent(){
    if(!selectedDate) return;
    const dateStr=selectedDate.toISOString().split('T')[0];
    const user=auth.currentUser;
    if(!user) return;
    db.collection("users").doc(user.uid).collection("events").doc(dateStr).delete()
      .then(()=>{ delete events[dateStr]; closePopup(); renderCalendar(); });
  }
</script>

</body>
</html>